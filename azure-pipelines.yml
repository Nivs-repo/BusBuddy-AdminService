# =========================
# Azure DevOps Pipeline for Admin Service (Microsoft-hosted Agent)
# =========================

trigger:
  branches:
    include:
      - main
      - feature/*

pr:
  branches:
    include:
      - main

variables:
  javaVersion: '17'
  artifactName: 'admin-service'
  buildDir: '$(Build.SourcesDirectory)/target'

stages:
# =========================
# 1Ô∏è‚É£ Build Stage
# =========================
- stage: Build
  displayName: 'Build Stage'
  jobs:
    - job: BuildJob
      displayName: 'Build Admin Service'
      pool:
        vmImage: 'ubuntu-latest'   # üëà switched to Microsoft hosted agent
      steps:
        - checkout: self

        # Build with Maven
        - task: Maven@3
          displayName: 'Build with Maven'
          inputs:
            mavenPomFile: 'pom.xml'
            goals: 'clean package -DskipTests'
          env:
            MAVEN_OPTS: "-Xmx1024m -Xms512m"   # üëà limit JVM memory to avoid OOM

        # Publish build artifact
        - task: PublishBuildArtifacts@1
          displayName: 'Publish Artifact'
          inputs:
            PathtoPublish: '$(buildDir)'
            ArtifactName: '$(artifactName)'
            publishLocation: 'Container'


# =========================
# 2Ô∏è‚É£ Deploy to Dev/Test (Feature Branches)
# =========================
- stage: DeployDev
  displayName: 'Deploy to Dev/Test'
  dependsOn: Build
  condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/heads/feature/'))
  jobs:
    - job: DeployDevJob
      displayName: 'Deploy to Dev/Test App Service'
      pool:
        vmImage: 'ubuntu-latest'   # üëà hosted agent
      steps:
        - task: DownloadBuildArtifacts@1
          inputs:
            buildType: 'current'
            downloadType: 'single'
            artifactName: '$(artifactName)'
            downloadPath: '$(Pipeline.Workspace)'

        - task: AzureWebApp@1
          displayName: 'Deploy to Dev/Test App Service'
          inputs:
            azureSubscription: 'azure-busbuddy-connection'
            appName: 'admin-service-app'
            package: '$(Pipeline.Workspace)/$(artifactName)/*.jar'


# =========================
# 3Ô∏è‚É£ Deploy to Prod (Main Branch)
# =========================
- stage: DeployProd
  displayName: 'Deploy to Production'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
    - job: DeployProdJob
      displayName: 'Deploy to Production App Service'
      pool:
        vmImage: 'ubuntu-latest'   # üëà hosted agent
      steps:
        - task: DownloadBuildArtifacts@1
          inputs:
            buildType: 'current'
            downloadType: 'single'
            artifactName: '$(artifactName)'
            downloadPath: '$(Pipeline.Workspace)'

        - task: AzureWebApp@1
          displayName: 'Deploy to Production App Service'
          inputs:
            azureSubscription: 'azure-busbuddy-connection'
            appName: 'admin-service-app'
            package: '$(Pipeline.Workspace)/$(artifactName)/*.jar'
